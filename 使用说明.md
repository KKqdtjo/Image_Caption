# 图像描述生成模型使用说明

## 项目结构

```
├── dataset.py          # 数据集加载和预处理
├── model.py           # CNN编码器+LSTM解码器模型
├── main.py            # 训练和预测主脚本
├── eval.py            # 模型评估脚本
├── requirements.txt   # 项目依赖
├── flickr8k_aim3/     # 数据集文件夹
│   ├── dataset_flickr8k.json
│   └── images/
└── 使用说明.md        # 本文件
```

## 环境配置

1. 安装依赖包：

```bash
pip install -r requirements.txt
```

2. 如果你有NVIDIA GPU，建议安装CUDA版本的PyTorch以加速训练。

## 模型架构

### 编码器 (ImageEncoder)

- 使用预训练的ResNet-50作为特征提取器
- 冻结ResNet参数，只训练最后的线性映射层
- 将2048维的ResNet特征映射到指定的嵌入维度

### 解码器 (TextDecoder)  

- 使用LSTM作为文本生成器
- 支持变长序列的处理
- 包含词嵌入层、LSTM层和输出层

## 使用方法

### 1. 训练模型

```bash
python main.py --mode train --num_epochs 20 --batch_size 32
```

主要参数说明：

- `--embed_size`: 嵌入维度 (默认256)
- `--hidden_size`: LSTM隐藏层维度 (默认512)
- `--num_epochs`: 训练轮数 (默认10)
- `--batch_size`: 批次大小 (默认32)
- `--learning_rate`: 学习率 (默认0.001)

### 2. 在测试集上评估

```bash
python main.py --mode test
```

或者使用专门的评估脚本：

```bash
python eval.py --split test
```

### 3. 单张图像演示

```bash
python main.py --mode demo --demo_image flickr8k_aim3/images/1000268201_693b08cb0e.jpg
```

### 4. 快速测试数据加载

```bash
python dataset.py
```

### 5. 快速测试模型结构

```bash
python model.py
```

## 训练过程

1. **数据预处理**：
   - 构建词汇表（过滤低频词）
   - 图像resize到224x224并标准化
   - 文本添加开始和结束标记

2. **模型训练**：
   - 使用交叉熵损失函数
   - Adam优化器
   - 每个epoch后在验证集上评估
   - 保存验证损失最低的模型

3. **生成训练曲线**：
   - 自动保存训练过程图表到 `training_curve.png`

## 评估指标

模型使用以下指标进行评估：

- **BLEU-1/2/3/4**: 测量n-gram重叠度
- **METEOR**: 考虑同义词和词序的指标  
- **ROUGE-1/2/L**: 测量召回率的指标

## 文件说明

### dataset.py

- `Vocabulary`: 词汇表类，处理文本编码解码
- `Flickr8kDataset`: 数据集类，加载图像和文本
- `build_vocab()`: 构建词汇表函数
- `get_data_loader()`: 创建数据加载器

### model.py

- `ImageEncoder`: 图像编码器，基于ResNet-50
- `TextDecoder`: 文本解码器，基于LSTM
- `ImageCaptioningModel`: 完整模型，结合编码器和解码器

### main.py

- `train_model()`: 主训练函数
- `predict_on_test_set()`: 测试集预测
- `generate_caption()`: 单张图像描述生成

### eval.py

- `evaluate_model()`: 完整的模型评估
- 各种评估指标的计算函数

## 预期结果

在Flickr8K数据集上，基础模型的预期性能：

- BLEU-1: ~0.50-0.60
- BLEU-4: ~0.15-0.25
- METEOR: ~0.15-0.20

## 优化建议

1. **模型结构优化**：
   - 尝试注意力机制
   - 使用更大的预训练模型（如ResNet-101）
   - 实验不同的LSTM层数和隐藏层维度

2. **训练策略优化**：
   - 学习率调度
   - 数据增强
   - 更多的训练轮数

3. **解码策略优化**：
   - Beam Search代替贪婪搜索
   - 长度惩罚

## 常见问题

1. **内存不足**：减小batch_size
2. **训练太慢**：减小图像尺寸或使用更小的模型
3. **生成质量差**：增加训练轮数，调整学习率，或使用更复杂的模型结构
